// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceType {
  TRADIE
  AGENT
}

enum DealStage {
  NEW
  CONTACTED
  NEGOTIATION
  WON
  LOST
  INVOICED
  ARCHIVED
}

model Workspace {
  id        String        @id @default(cuid())
  name      String
  type      WorkspaceType
  users     User[]
  deals     Deal[]
  contacts  Contact[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String?
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  activities  Activity[]
}

model Deal {
  id             String    @id @default(cuid())
  title          String
  stage          DealStage @default(NEW)
  value          Decimal?
  
  // Polymorphic Metadata: Stores "Job Details" (Tradie) or "Listing Details" (Agent)
  metadata       Json?     
  
  lastActivityAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  workspaceId    String
  workspace      Workspace @relation(fields: [workspaceId], references: [id])
  
  contacts       Contact[]
  activities     Activity[]
  tasks          Task[]
}

model Contact {
  id          String    @id @default(cuid())
  name        String
  email       String?
  phone       String?
  
  // Preferences for Matchmaker (e.g., { "budget": 1200000, "bedrooms": 3 })
  preferences Json?
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  deals       Deal[]
  activities  Activity[]
  tasks       Task[]
}

model Activity {
  id          String   @id @default(cuid())
  description String
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  dealId      String?
  deal        Deal?    @relation(fields: [dealId], references: [id])
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  createdAt   DateTime @default(now())
}

model Task {
  id          String   @id @default(cuid())
  title       String
  completed   Boolean  @default(false)
  dueAt       DateTime?
  
  dealId      String?
  deal        Deal?    @relation(fields: [dealId], references: [id])
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
